<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WhatsApp-style Chat (Demo)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
/* ====== Base / WhatsApp-ish iPhone style ====== */
:root{
  --bg:#f6f8fb;
  --card:#ffffff;
  --muted:#6b7580;
  --accent:#25d366;
  --bubble-me:#dcf8c6;
  --bubble-other:#ffffff;
  --sidebar-w:320px;
  --anim-fast:220ms;
  --text:#0b1220;
  --border: rgba(0,0,0,0.06);
  --overlay-bg: rgba(0,0,0,0.38);
}
[data-theme="dark"]{
  --bg:#041018;
  --card:#062027;
  --muted:#9bb0bf;
  --accent:#25d366;
  --bubble-me:#154d2b;
  --bubble-other:#08333a;
  --text:#e6f2f8;
  --border: rgba(255,255,255,0.06);
  --overlay-bg: rgba(0,0,0,0.55);
  color-scheme: dark;
}

/* Reset & base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter, system-ui, -apple-system, "Helvetica Neue", Arial;
  background:linear-gradient(180deg,var(--bg),#fff);
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  color:var(--text);
}

/* App container - full width on desktop */
.app{
  width:100%;
  max-width:1400px;
  height:100vh;
  border-radius:12px;
  overflow:hidden;
  display:flex;
  background:var(--card);
  box-shadow:0 18px 50px rgba(0,0,0,0.12);
  position:relative;
}

/* Sidebar (left column) */
.sidebar{
  width:var(--sidebar-w);
  min-width:var(--sidebar-w);
  display:flex;
  flex-direction:column;
  border-right:1px solid var(--border);
  background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  transform:translateX(0);
  transition:transform var(--anim-fast) ease, box-shadow var(--anim-fast) ease;
  z-index:20;
  background-color: transparent;
}

/* When hidden on mobile */
.sidebar.hidden { transform: translateX(-110%); box-shadow:none; }

/* header */
.header{
  height:72px; display:flex; align-items:center; justify-content:space-between;
  padding:12px 14px; border-bottom:1px solid var(--border);
  background:linear-gradient(180deg, rgba(0,0,0,0.01), transparent);
}
.brand{display:flex;align-items:center;gap:12px}
.brand .logo{width:46px;height:46px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
.header .actions{display:flex;gap:8px;align-items:center}
.iconBtn{background:transparent;border:none;padding:8px;border-radius:10px;cursor:pointer;font-size:18px;color:var(--text)}

/* Search and create */
.controls{padding:12px}
.searchBox{display:flex;gap:8px;align-items:center}
.searchBox input{flex:1;padding:10px;border-radius:999px;border:1px solid var(--border);background:transparent;color:var(--text)}
.createRow{display:flex;gap:8px;margin-top:10px}
.createRow input{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}
.small{font-size:12px;color:var(--muted)}

/* Room list */
.roomList{overflow:auto;padding:8px 12px; display:flex;flex-direction:column; gap:8px}
.roomItem{display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;background:linear-gradient(180deg, rgba(0,0,0,0.01), transparent);cursor:pointer}
.roomItem:hover{filter:brightness(.99)}
.roomAvatar{width:44px;height:44px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
.roomMeta{flex:1;display:flex;flex-direction:column}
.roomTitle{font-weight:600;color:var(--text)}
.roomSub{font-size:12px;color:var(--muted)}

/* Chat panel */
.chat{
  flex:1; display:flex; flex-direction:column; min-width:0;
  position:relative; background:var(--card);
}

/* chat header */
.chatHeader{
  height:72px;padding:10px 14px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
}
.chatHeader .left{display:flex;gap:12px;align-items:center}
.chatHeader .avatar{width:46px;height:46px;border-radius:12px;background:#e6eef6;display:flex;align-items:center;justify-content:center}
.chatHeader .info{display:flex;flex-direction:column;min-width:0}
.chatHeader .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text)}
.chatHeader .status{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Back button - mobile only */
.backBtn{display:none;margin-right:6px;padding:8px;border-radius:8px;border:none;background:transparent;cursor:pointer;color:var(--text)}

/* messages */
.messages{flex:1; padding:12px; overflow:auto; background:linear-gradient(180deg, rgba(0,0,0,0.01), transparent)}
.msgRow{display:flex; width:100%;}
.msgRow.me{justify-content:flex-end}
.bubble{
  display:inline-block; max-width:78%; padding:10px 12px; border-radius:18px; position:relative; margin:6px 0; word-break:break-word; box-shadow:0 2px 6px rgba(0,0,0,0.04);
  color:var(--text); /* default; may be overridden per-bubble */
}
.bubble .sender{font-weight:700;font-size:12px;margin-bottom:6px}
.bubble .text{white-space:pre-wrap}
.bubble .meta{font-size:11px; opacity:.75; margin-top:6px; display:flex;align-items:center;gap:8px}
.bubble.me{background:var(--bubble-me)}
.bubble.other{background:var(--bubble-other)}
.bubble .actions{position:absolute; top:6px; right:8px; display:flex; gap:6px}
.smallIcon{font-size:12px; padding:6px; border-radius:6px; cursor:pointer; opacity:.8;background:transparent;border:none}

/* composer */
.composer{display:flex;padding:10px;border-top:1px solid var(--border);gap:8px;align-items:center}
.composer input{flex:1;padding:12px;border-radius:999px;border:1px solid var(--border);background:transparent;color:var(--text)}
.composer .sendBtn{background:var(--accent);color:white;padding:10px 12px;border-radius:999px;border:none;cursor:pointer}

/* small helpers */
.pill{padding:6px 10px;border-radius:999px;background:rgba(0,0,0,0.04);font-size:12px}
.topRightControls{display:flex;gap:8px;align-items:center}

/* overlays / panels */
.overlay{position:fixed;inset:0;background:var(--overlay-bg);display:none;align-items:center;justify-content:center;z-index:40}
.panel{background:var(--card);padding:18px;border-radius:10px;width:90%;max-width:420px}
.field{margin-top:10px}

/* Welcome full-screen (option B) */
#welcome {
  position:absolute; inset:0; z-index:60;
  display:none; align-items:center; justify-content:center;
  transition:opacity var(--anim-fast) ease, visibility var(--anim-fast);
}
#welcome.active{
  display:flex;
  background:linear-gradient(180deg, rgba(0,0,0,0.38), rgba(0,0,0,0.22));
}
#welcome .box{
  width:100%; max-width:520px; background:var(--card); border-radius:12px; padding:28px; text-align:center;
  transform:translateY(0); transition:transform var(--anim-fast) ease, opacity var(--anim-fast) ease;
  box-shadow:0 20px 50px rgba(0,0,0,0.12);
}
#welcome h1{margin:0 0 12px;font-size:24px}
#welcome p{margin:0 0 18px;color:var(--muted)}
#welcome .nameInput{width:100%; padding:12px;border-radius:10px;border:1px solid var(--border); margin-bottom:12px;background:transparent;color:var(--text)}
#welcome .startBtn{background:var(--accent); color:white; padding:12px 18px; border-radius:10px; border:none; cursor:pointer}

/* Animations: hide */
#welcome.hidden{opacity:0; visibility:hidden; transform:none; pointer-events:none}

/* mobile responsive */
@media (max-width:900px){
  .app{border-radius:0}
  .sidebar{position:absolute;left:0;top:0;bottom:0;height:100%;box-shadow:0 20px 40px rgba(0,0,0,0.12)}
  .sidebar.hidden{transform:translateX(-110%);}
  .chat{flex:1; margin-left:0}
  .brand .logo{width:40px;height:40px}
  .backBtn{display:inline-flex}
  .header .actions{gap:6px}
  .chat.hidden { display:none; }
}

/* small mobile tweaks */
@media (max-width:520px){
  #welcome .box{margin:18px}
  .searchBox input{padding:8px}
  .createRow input{padding:8px}
}

/* helper for accessibility */
.visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
</style>
</head>
<body data-theme="light">
<div class="app" role="application" aria-label="WhatsApp style chat" id="appRoot">

  <!-- LEFT: header + controls + room list -->
  <div class="sidebar" id="sidebar" aria-hidden="false">
    <div class="header">
      <div class="brand">
        <div class="logo">WA</div>
        <div><strong>Chat</strong></div>
      </div>
      <div class="actions">
        <button class="iconBtn" id="themeToggle" title="Toggle theme">üåô</button>
      </div>
    </div>

    <div class="controls">
      <div class="searchBox">
        <input id="searchRoomInput" placeholder="Search rooms or messages..." aria-label="Search rooms or messages">
        <button id="searchBtn" class="iconBtn" aria-label="Search">üîé</button>
      </div>

      <div class="createRow">
        <input id="createRoomId" placeholder="New room id" aria-label="New room id">
        <button id="createRoomBtn">Create</button>
      </div>

      <div class="createRow" style="margin-top:8px">
        <input id="createRoomPass" placeholder="Room password (optional)" aria-label="Room password (optional)">
        <input id="createAdminPass" placeholder="Admin password (optional)" aria-label="Admin password (optional)">
      </div>

      <div class="small" style="margin-top:8px">Enter your device name on first join</div>
    </div>

    <div class="roomList" id="roomList" role="list" aria-label="Rooms"></div>
  </div>

  <!-- RIGHT: chat panel -->
  <div class="chat hidden" id="chatPanel" aria-hidden="true">
    <div class="chatHeader">
      <div class="left">
        <button id="backBtn" class="backBtn" title="Back">‚Üê</button>
        <button id="sidebarToggle" class="iconBtn" title="Toggle sidebar">‚ò∞</button>
        <div class="avatar" id="chatAvatar">üí¨</div>
        <div class="info">
          <div class="title" id="chatTitle">Select a room</div>
          <div class="status" id="chatStatus">‚Äî</div>
        </div>
      </div>

      <div class="topRightControls">
        <div id="onlineCount" class="pill">0 online</div>
        <button id="pinBtn" class="themeBtn">Pin</button>
        <button id="deleteRoomBtn" class="themeBtn">Delete Room</button>
      </div>
    </div>

    <div class="onlineList" id="onlineList" aria-live="polite" style="padding:8px;display:flex;flex-direction:column;gap:6px"></div>

    <div id="messages" class="messages" role="log" aria-atomic="false"></div>

    <div id="typingLine" class="small" style="padding:6px 12px;color:var(--muted)"></div>

    <div class="composer">
      <input id="messageInput" placeholder="Message" aria-label="Message">
      <input id="colorPicker" placeholder="#aabbcc" style="width:110px" aria-label="Message color (#hex)">
      <button class="sendBtn" id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- Welcome full screen -->
<div id="welcome" role="dialog" aria-modal="true" aria-label="Enter display name">
  <div class="box" id="welcomeBox">
    <h1>Welcome to WA Chat</h1>
    <p>Please enter your display name to continue.</p>
    <input id="welcomeName" class="nameInput" type="text" placeholder="Your display name (e.g. Alex Phone)" maxlength="40" />
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="startBtn" class="startBtn">Start Chat</button>
    </div>
  </div>
</div>

<!-- overlays / modals -->
<div id="overlay" class="overlay" role="dialog" aria-hidden="true">
  <div class="panel" id="overlayPanel"></div>
</div>

<!-- Firebase SDK (modular) -->
<script type="module">
/* ========= FIREBASE IMPORTS ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import {
  getDatabase, ref, set, push, onValue, remove, get, update, onDisconnect
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

/* ===== REPLACE with your Firebase config if needed ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDRQq8I9ebaYGiyYy0LfKXTy5IFDzj8PFE",
  authDomain: "message-d4df0.firebaseapp.com",
  databaseURL: "https://message-d4df0-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "message-d4df0",
  storageBucket: "message-d4df0.firebasedestorage.app",
  messagingSenderId: "1004865992718",
  appId: "1:1004865992718:web:cbd37f7bcfce36521c645f"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ========= App state & helpers ========= */
const sidebar = document.getElementById('sidebar');
const chatPanel = document.getElementById('chatPanel');
const roomListEl = document.getElementById('roomList');
const createRoomBtn = document.getElementById('createRoomBtn');
const createRoomId = document.getElementById('createRoomId');
const createRoomPass = document.getElementById('createRoomPass');
const createAdminPass = document.getElementById('createAdminPass');
const searchRoomInput = document.getElementById('searchRoomInput');

const chatTitle = document.getElementById('chatTitle');
const chatStatus = document.getElementById('chatStatus');
const messagesEl = document.getElementById('messages');
const onlineListEl = document.getElementById('onlineList');
const onlineCount = document.getElementById('onlineCount');
const typingLine = document.getElementById('typingLine');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const colorPicker = document.getElementById('colorPicker');
const overlay = document.getElementById('overlay');
const overlayPanel = document.getElementById('overlayPanel');
const deleteRoomBtn = document.getElementById('deleteRoomBtn');
const pinBtn = document.getElementById('pinBtn');
const themeToggle = document.getElementById('themeToggle');
const sidebarToggle = document.getElementById('sidebarToggle');
const backBtn = document.getElementById('backBtn');

const welcome = document.getElementById('welcome');
const welcomeName = document.getElementById('welcomeName');
const startBtn = document.getElementById('startBtn');

let deviceId = localStorage.getItem('wa_device_id');
if(!deviceId){ deviceId = 'u_' + Math.random().toString(36).slice(2,9); localStorage.setItem('wa_device_id', deviceId); }
let deviceName = localStorage.getItem('wa_device_name') || '';
let deviceColor = localStorage.getItem('wa_device_color') || '';

const messageKeysAdded = [];
const pendingDisconnects = new Set();

/* Helpers */
function saveLocalIdentity(name,color){
  if(name){ deviceName = name; localStorage.setItem('wa_device_name', name); }
  if(color){ deviceColor = color; localStorage.setItem('wa_device_color', color); }
}
function ensureIdentity(){ if(!deviceName) return false; if(!deviceColor){ deviceColor = deterministicColor(deviceName || deviceId); localStorage.setItem('wa_device_color', deviceColor);} return true; }
function deterministicColor(s){
  const palette = ["#2b7cff","#2fc27f","#ffb84d","#9863ff","#ff6b6b","#06b6d4","#f97316","#7c3aed"];
  if(!s) return palette[0];
  let h=0; for(let i=0;i<s.length;i++) h=(h<<5)-h + s.charCodeAt(i);
  return palette[Math.abs(h) % palette.length];
}
/* simple sanitize */
function esc(s){ if(s===undefined || s===null) return ''; return s.toString().replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* Contrast helper: return '#000' or '#fff' for readable text over given hex */
function contrastColorForHex(hex){
  if(!hex) return '#000';
  hex = hex.replace('#','').trim();
  if(hex.length === 3) hex = hex.split('').map(c=>c+c).join('');
  const r = parseInt(hex.slice(0,2),16);
  const g = parseInt(hex.slice(2,4),16);
  const b = parseInt(hex.slice(4,6),16);
  // relative luminance
  const lum = (0.2126*srgb(r) + 0.7152*srgb(g) + 0.0722*srgb(b));
  return lum > 0.5 ? '#000' : '#fff';
}
function srgb(v){ v = v/255; return v <= 0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055,2.4); }

/* theme toggle */
(function initThemeButton(){
  const body = document.body;
  const cur = body.getAttribute('data-theme') || 'light';
  themeToggle.textContent = cur === 'light' ? 'üåô' : '‚òÄÔ∏è';
})();
themeToggle.addEventListener('click', ()=>{
  const body = document.body;
  const cur = body.getAttribute('data-theme') || 'light';
  const next = cur === 'light' ? 'dark' : 'light';
  body.setAttribute('data-theme', next);
  themeToggle.textContent = next === 'light' ? 'üåô' : '‚òÄÔ∏è';
});

/* sidebar toggle (mobile) */
sidebarToggle && sidebarToggle.addEventListener('click', ()=>{
  if(sidebar.classList.contains('hidden')) sidebar.classList.remove('hidden');
  else sidebar.classList.toggle('hidden');
});

/* back button (mobile): show sidebar and hide chat */
backBtn && backBtn.addEventListener('click', ()=>{
  if(window.matchMedia('(max-width:900px)').matches){
    sidebar.classList.remove('hidden');
    chatPanel.classList.add('hidden');
    chatPanel.setAttribute('aria-hidden','true');
    sidebar.setAttribute('aria-hidden','false');
  }
});

/* close overlay when clicked out */
overlay.addEventListener('click', (e)=>{ if(e.target === overlay) overlay.style.display='none'; });

/* ======= Welcome / Name flow (Option B) ======= */
function openWelcomeIfNeeded(){
  if(!deviceName){
    welcome.classList.add('active');
    welcome.classList.remove('hidden');
    welcome.style.display = 'flex';
    welcomeName.focus();
    // hide main UI behind welcome (avoid mixing)
    document.getElementById('appRoot').style.filter = 'blur(2px) brightness(.8)';
    sidebar.classList.add('hidden');
    chatPanel.classList.add('hidden');
    chatPanel.setAttribute('aria-hidden','true');
    sidebar.setAttribute('aria-hidden','true');
  } else {
    welcome.classList.remove('active');
    welcome.classList.add('hidden');
    welcome.style.display = 'none';
    document.getElementById('appRoot').style.filter = '';
    if(window.matchMedia('(max-width:900px)').matches){
      sidebar.classList.remove('hidden'); chatPanel.classList.add('hidden');
      chatPanel.setAttribute('aria-hidden','true'); sidebar.setAttribute('aria-hidden','false');
    } else {
      sidebar.classList.remove('hidden'); chatPanel.classList.remove('hidden');
      chatPanel.setAttribute('aria-hidden','false'); sidebar.setAttribute('aria-hidden','false');
    }
  }
}

startBtn.addEventListener('click', ()=>{
  const name = (welcomeName.value || '').trim();
  if(!name){ alert('Please enter a display name'); welcomeName.focus(); return; }
  saveLocalIdentity(name, deterministicColor(name));
  welcome.classList.add('hidden');
  setTimeout(()=> welcome.style.display='none', 300);
  document.getElementById('appRoot').style.filter = '';
  if(window.matchMedia('(max-width:900px)').matches){
    sidebar.classList.remove('hidden'); chatPanel.classList.add('hidden');
  } else {
    sidebar.classList.remove('hidden'); chatPanel.classList.remove('hidden');
  }
  initAfterIdentity();
});
welcomeName.addEventListener('keydown', e=>{ if(e.key==='Enter') startBtn.click(); });

/* ======= Firebase paths & state ======= */
let currentRoom = null;
let currentRoomMeta = null;
let msgsRef = null, typingRef = null, onlineRef = null;
let typingTimer = null;

/* ======= Create room ======= */
createRoomBtn.addEventListener('click', async ()=>{
  const id = createRoomId.value.trim();
  if(!id){ alert('Enter a room id'); return; }
  if(!ensureIdentity()) return alert('Name not set');
  const pass = createRoomPass.value || '';
  const adminPass = createAdminPass.value || '';
  const roomMeta = { password: pass, adminId: deviceId, adminPass: adminPass || '', createdAt: Date.now() };
  await set(ref(db, 'rooms/' + id), roomMeta);
  createRoomId.value=''; createRoomPass.value=''; createAdminPass.value='';
  alert('Created room: ' + id);
});

/* ======= Room list live ======= */
function attachRoomsListener(){
  onValue(ref(db,'rooms'), snap=>{
    const data = snap.val() || {};
    roomListEl.innerHTML = '';
    const keys = Object.keys(data).sort();
    if(keys.length===0){ roomListEl.innerHTML = '<div class="small">No rooms yet</div>'; return; }
    for(const k of keys){
      const meta = data[k];
      const item = document.createElement('div'); item.className='roomItem';
      item.innerHTML = `<div class="roomAvatar">${esc(k.slice(0,2).toUpperCase())}</div>
        <div class="roomMeta"><div class="roomTitle">${esc(k)}</div><div class="roomSub">${meta && meta.password ? 'üîí Private' : 'Public'}</div></div>`;
      item.onclick = ()=> tryJoinRoom(k);
      roomListEl.appendChild(item);
    }
  });
}

/* ======= Try joining a room (password check) ======= */
async function tryJoinRoom(roomId){
  if(!ensureIdentity()) return alert('Name not set');
  const snap = await get(ref(db, 'rooms/' + roomId));
  if(!snap.exists()){ alert('Room not found'); return; }
  const meta = snap.val();
  if(meta.password){
    const entered = prompt('Enter room password:') || '';
    if(entered !== meta.password) return alert('Wrong password');
  }
  openRoom(roomId, meta);
  if(window.matchMedia('(max-width:900px)').matches){
    sidebar.classList.add('hidden');
    chatPanel.classList.remove('hidden');
    chatPanel.setAttribute('aria-hidden','false'); sidebar.setAttribute('aria-hidden','true');
  } else {
    chatPanel.classList.remove('hidden');
    chatPanel.setAttribute('aria-hidden','false');
  }
}

/* ======= Open room: attach listeners ======= */
async function openRoom(roomId, meta){
  currentRoom = roomId;
  currentRoomMeta = meta || (await get(ref(db,'rooms/'+roomId))).val();
  chatTitle.textContent = 'Room: ' + roomId;
  chatStatus.textContent = 'Connected';
  messagesEl.innerHTML = ''; onlineListEl.innerHTML=''; typingLine.textContent='';
  msgsRef = ref(db, 'messages/' + roomId);
  typingRef = ref(db, 'typing/' + roomId);
  onlineRef = ref(db, 'online/' + roomId);

  // set presence
  await set(ref(db, `online/${roomId}/${deviceId}`), { name: deviceName, color: deviceColor, ts: Date.now() });

  try{
    onDisconnect(ref(db, `online/${roomId}/${deviceId}`)).remove();
    onDisconnect(ref(db, `typing/${roomId}/${deviceId}`)).remove();
  }catch(e){ console.warn('onDisconnect failed', e); }

  // online listener
  onValue(onlineRef, snap=>{
    const val = snap.val() || {};
    onlineListEl.innerHTML = '';
    const keys = Object.keys(val);
    onlineCount.textContent = keys.length + ' online';
    for(const id of keys){
      const u = val[id];
      const el = document.createElement('div'); el.className='onlineItem';
      el.style.borderLeft = '6px solid ' + (u.color || '#777');
      el.style.padding = '6px 10px';
      el.style.borderRadius = '6px';
      el.textContent = (u.name || id);
      onlineListEl.appendChild(el);
    }
  });

  // typing listener
  onValue(typingRef, snap=>{
    const t = snap.val() || {};
    const names = Object.keys(t).filter(k=>k!==deviceId).map(k=>t[k]?.name || k);
    typingLine.textContent = names.length ? names.join(', ') + ' is typing‚Ä¶' : '';
  });

  // messages listener
  onValue(msgsRef, snap=>{
    const msgs = snap.val() || {};
    messagesEl.innerHTML = '';
    const keys = Object.keys(msgs).sort((a,b)=> (msgs[a].ts||0) - (msgs[b].ts||0));
    for(const k of keys) renderMessage(k, msgs[k]);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });

  // load pinned if exists
  const pinnedSnap = await get(ref(db, `pinned/${roomId}`));
  if(pinnedSnap.exists()){
    pinBtn.textContent = 'Unpin';
  } else pinBtn.textContent = 'Pin';

  // cleanup
  await cleanupOldMessages(roomId);
  setInterval(()=>cleanupOldMessages(roomId), 60*60*1000);
}

/* ======= Render message with features (reactions, reply, edit, delete, read receipts) ======= */
async function renderMessage(key, m){
  try{
    const row = document.createElement('div'); row.className = 'msgRow ' + (m.deviceId === deviceId ? 'me' : 'other');
    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + (m.deviceId === deviceId ? 'me' : 'other');

    // choose background color (user-specified color preferred)
    const bg = (m.color && /^#?[0-9A-Fa-f]{6}$/.test(m.color)) ? (m.color[0]==="#"?m.color:"#"+m.color) : (m.deviceId === deviceId ? getComputedStyle(document.documentElement).getPropertyValue('--bubble-me').trim() : getComputedStyle(document.documentElement).getPropertyValue('--bubble-other').trim());
    bubble.style.background = bg;
    // set readable text color on bubble
    bubble.style.color = contrastColorForHex(bg.replace('#',''));

    // header: sender
    const sender = document.createElement('div'); sender.className = 'sender';
    sender.innerHTML = esc(m.deviceName || m.deviceId);
    bubble.appendChild(sender);

    // reply
    if(m.replyTo){
      const replyDiv = document.createElement('div');
      replyDiv.style.fontSize='12px'; replyDiv.style.opacity='.8'; replyDiv.style.padding='6px'; replyDiv.style.borderLeft='3px solid rgba(0,0,0,0.06)';
      replyDiv.textContent = 'Reply ‚Üí ' + (m.replyToText ? m.replyToText.slice(0,80) : '(deleted)');
      bubble.appendChild(replyDiv);
    }

    // text
    const t = document.createElement('div'); t.className='text'; t.innerHTML = esc(m.text);
    bubble.appendChild(t);

    // reactions
    if(m.reactions){
      const rwrap = document.createElement('div'); rwrap.style.marginTop='8px'; rwrap.style.display='flex'; rwrap.style.gap='6px';
      const map = m.reactions;
      for(const r in map){
        const span = document.createElement('div'); span.className='pill'; span.style.padding='6px'; span.textContent = `${r} ${Object.keys(map[r]).length}`;
        rwrap.appendChild(span);
      }
      bubble.appendChild(rwrap);
    }

    // meta: time + read receipts
    const meta = document.createElement('div'); meta.className = 'meta';
    const timeSpan = document.createElement('span'); timeSpan.textContent = new Date(m.ts).toLocaleTimeString();
    meta.appendChild(timeSpan);

    const readSpan = document.createElement('span');
    if(m.readBy){
      const readCount = Object.keys(m.readBy).length;
      if(readCount > 0) readSpan.textContent = '‚úì‚úì'; else readSpan.textContent = '‚úì';
    } else { readSpan.textContent = '‚úì'; }
    meta.appendChild(readSpan);
    bubble.appendChild(meta);

    // actions
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px'; actions.style.marginTop='6px';
    const replyBtn = document.createElement('button'); replyBtn.className='smallIcon'; replyBtn.textContent='‚Ü©Ô∏è'; replyBtn.title='Reply';
    replyBtn.onclick = ()=> startReply(key, m);
    actions.appendChild(replyBtn);
    const reactBtn = document.createElement('button'); reactBtn.className='smallIcon'; reactBtn.textContent='üòä'; reactBtn.title='React';
    reactBtn.onclick = ()=> showReactionPicker(key, m);
    actions.appendChild(reactBtn);
    if(m.deviceId === deviceId){
      const editBtn = document.createElement('button'); editBtn.className='smallIcon'; editBtn.textContent='‚úèÔ∏è'; editBtn.title='Edit';
      editBtn.onclick = ()=> startEdit(key, m);
      actions.appendChild(editBtn);
    }
    const allowDelete = (m.deviceId === deviceId) || (currentRoomMeta && currentRoomMeta.adminId === deviceId);
    if(allowDelete){
      const delBtn = document.createElement('button'); delBtn.className='smallIcon'; delBtn.textContent='üóëÔ∏è'; delBtn.title='Delete';
      delBtn.onclick = async ()=> { if(confirm('Delete message?')) await remove(ref(db, `messages/${currentRoom}/${key}`)); };
      actions.appendChild(delBtn);
    }
    bubble.appendChild(actions);

    bubble.onclick = async ()=>{
      const readRef = ref(db, `messages/${currentRoom}/${key}/readBy/${deviceId}`);
      await set(readRef, { name: deviceName, ts: Date.now() });
    };

    row.appendChild(bubble);
    messagesEl.appendChild(row);
  }catch(e){ console.error(e) }
}

/* ======== Reactions picker ======== */
function showReactionPicker(key,m){
  const react = prompt('Enter reaction emoji (e.g. ‚ù§Ô∏è, üëç):');
  if(!react) return;
  const rxRef = ref(db, `messages/${currentRoom}/${key}/reactions/${react}/${deviceId}`);
  set(rxRef, { name: deviceName, ts: Date.now() });
}

/* ======== Reply flow ======== */
function startReply(key,m){
  const confirmReply = confirm(`Reply to ${m.deviceName || m.deviceId} message?`);
  if(!confirmReply) return;
  messageInput.dataset.replyToKey = key;
  messageInput.dataset.replyToText = m.text.slice(0,200);
  messageInput.placeholder = `Replying to ${m.deviceName || m.deviceId}‚Ä¶`;
  messageInput.focus();
}

/* ======== Edit message flow ======== */
function startEdit(key,m){
  const newText = prompt('Edit message:', m.text);
  if(newText === null) return;
  update(ref(db, `messages/${currentRoom}/${key}`), { text: newText, edited: true }).catch(e=>console.error(e));
}

/* ======== Pin room message ======== */
pinBtn.addEventListener('click', async ()=>{
  if(!currentRoom) return alert('Open a room first');
  const pinnedSnap = await get(ref(db, `pinned/${currentRoom}`));
  if(pinnedSnap.exists()){
    await remove(ref(db, `pinned/${currentRoom}`));
    pinBtn.textContent = 'Pin';
    alert('Unpinned');
  } else {
    const key = prompt('Enter message key to pin (or leave blank to pin latest):','');
    if(key){
      const mSnap = await get(ref(db, `messages/${currentRoom}/${key}`));
      if(!mSnap.exists()) return alert('Message not found');
      await set(ref(db, `pinned/${currentRoom}`), mSnap.val());
      pinBtn.textContent = 'Unpin';
      alert('Pinned');
    } else {
      const messagesSnap = await get(ref(db, `messages/${currentRoom}`));
      const msgs = messagesSnap.val() || {};
      const keys = Object.keys(msgs).sort((a,b)=> (msgs[a].ts||0) - (msgs[b].ts||0));
      if(keys.length===0) return alert('No messages to pin');
      await set(ref(db, `pinned/${currentRoom}`), msgs[keys[keys.length-1]]);
      pinBtn.textContent = 'Unpin'; alert('Pinned latest');
    }
  }
});

/* ======== Delete entire room (admin only) ======== */
deleteRoomBtn.addEventListener('click', async ()=>{
  if(!currentRoom) return alert('Open a room first');
  const snap = await get(ref(db, `rooms/${currentRoom}`));
  const meta = snap.val() || {};
  if(meta.adminId !== deviceId){
    const pass = prompt('Enter admin password to delete room (or leave blank):') || '';
    if(pass !== meta.adminPass) return alert('Not authorized');
  }
  if(!confirm('Delete entire room and all messages?')) return;
  await remove(ref(db, `rooms/${currentRoom}`));
  await remove(ref(db, `messages/${currentRoom}`));
  await remove(ref(db, `online/${currentRoom}`));
  await remove(ref(db, `typing/${currentRoom}`));
  alert('Room deleted');
  currentRoom = null; messagesEl.innerHTML=''; onlineListEl.innerHTML=''; chatTitle.textContent='Select a room'; chatStatus.textContent='‚Äî';
});

/* ======== Send message (with reply context, custom color) ======== */
sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendMessage(); else signalTyping(); });

async function sendMessage(){
  if(!currentRoom) return alert('Open a room first');
  const text = messageInput.value.trim();
  if(!text) return;
  const customColor = (colorPicker.value || '').trim();
  const color = customColor && /^#?[0-9A-Fa-f]{6}$/.test(customColor) ? (customColor[0]==="#"?customColor:"#"+customColor) : (deviceColor || deterministicColor(deviceName||deviceId));
  const payload = {
    text,
    deviceId,
    deviceName,
    color,
    ts: Date.now()
  };
  if(messageInput.dataset.replyToKey){
    payload.replyTo = messageInput.dataset.replyToKey;
    payload.replyToText = messageInput.dataset.replyToText || '';
    delete messageInput.dataset.replyToKey; delete messageInput.dataset.replyToText;
    messageInput.placeholder = 'Message';
  }
  try{
    const pushed = await push(ref(db, `messages/${currentRoom}`), payload);
    const key = pushed.key;
    messageKeysAdded.push({ room: currentRoom, key });
    try{
      onDisconnect(ref(db, `messages/${currentRoom}/${key}`)).remove();
    }catch(e){ console.warn('onDisconnect for message failed', e); }
  }catch(e){
    console.error('send message failed', e);
  }
  messageInput.value='';
  colorPicker.value='';
  await remove(ref(db, `typing/${currentRoom}/${deviceId}`));
}

/* ======== Typing indicator ======== */
function signalTyping(){
  if(!currentRoom) return;
  set(ref(db, `typing/${currentRoom}/${deviceId}`), { name: deviceName, ts: Date.now() }).catch(()=>{});
  if(typingTimer) clearTimeout(typingTimer);
  typingTimer = setTimeout(()=> remove(ref(db, `typing/${currentRoom}/${deviceId}`)).catch(()=>{}), 1800);
}

/* ======== cleanup old messages after 24h ======== */
async function cleanupOldMessages(roomId){
  if(!roomId) return;
  try{
    const snap = await get(ref(db, `messages/${roomId}`));
    const msgs = snap.val() || {};
    const cutoff = Date.now() - 24*60*60*1000;
    for(const k in msgs){
      if(msgs[k].ts && msgs[k].ts <= cutoff){
        await remove(ref(db, `messages/${roomId}/${k}`));
      }
    }
  }catch(e){ console.warn('cleanup err', e); }
}

/* ======= Mark messages visible as read (read receipts) ======= */
setInterval(async ()=>{
  if(!currentRoom) return;
  const snap = await get(ref(db, `messages/${currentRoom}`));
  const msgs = snap.val() || {};
  for(const k in msgs){
    if(!(msgs[k].readBy && msgs[k].readBy[deviceId])){
      await set(ref(db, `messages/${currentRoom}/${k}/readBy/${deviceId}`), { name: deviceName, ts: Date.now() });
    }
  }
}, 5000);

/* ======= Cleanup user on unload ======= */
let cleanupInProgress = false;
async function cleanupUser(){
  if(cleanupInProgress) return;
  cleanupInProgress = true;
  try{
    if(currentRoom){
      try{ await remove(ref(db, `online/${currentRoom}/${deviceId}`)); }catch(e){/*ignore*/ }
      try{ await remove(ref(db, `typing/${currentRoom}/${deviceId}`)); }catch(e){/*ignore*/ }
    }
    for(const rec of messageKeysAdded){
      try{ await remove(ref(db, `messages/${rec.room}/${rec.key}`)); }catch(e){ /*ignore*/ }
    }
    try{
      const roomsSnap = await get(ref(db, 'rooms'));
      const rooms = roomsSnap.val() || {};
      for(const r in rooms){
        try{ await remove(ref(db, `online/${r}/${deviceId}`)); }catch(e){/*ignore*/ }
        try{ await remove(ref(db, `typing/${r}/${deviceId}`)); }catch(e){/*ignore*/ }
      }
    }catch(e){ /*ignore*/ }
    localStorage.removeItem('wa_device_name');
    localStorage.removeItem('wa_device_color');
    localStorage.removeItem('wa_device_id');
  }catch(e){
    console.warn('cleanupUser error', e);
  }finally{
    cleanupInProgress = false;
  }
}
window.addEventListener('beforeunload', (e)=>{
  cleanupUser();
});
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState === 'hidden') cleanupUser();
});

/* ======= Small utilities & init ======= */
function escHtml(s){ return esc(s); }
function escapeHtml(s){ return esc(s); }

function initAfterIdentity(){
  if(!deviceColor){ deviceColor = deterministicColor(deviceName || deviceId); localStorage.setItem('wa_device_color', deviceColor); }
  attachRoomsListener();
  if(window.matchMedia('(min-width:901px)').matches){
    chatPanel.classList.remove('hidden');
    sidebar.classList.remove('hidden');
    chatPanel.setAttribute('aria-hidden','false'); sidebar.setAttribute('aria-hidden','false');
  } else {
    chatPanel.classList.add('hidden');
    sidebar.classList.remove('hidden');
    chatPanel.setAttribute('aria-hidden','true'); sidebar.setAttribute('aria-hidden','false');
  }
}

(function init(){
  if(deviceName) welcomeName.value = deviceName;
  openWelcomeIfNeeded();
  if(deviceName) initAfterIdentity();
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ overlay.style.display='none'; messageInput.dataset.replyToKey=''; messageInput.placeholder='Message'; } });
})();
</script>
</body>
</html>
